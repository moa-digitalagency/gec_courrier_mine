# Journal des Modifications (CHANGELOG)

## [Correction Import de Courriers - Affichage des Erreurs] - 2025-10-15

### üêõ Correction Critique - Import/Export

#### Probl√®me: 0 courriers import√©s avec erreurs non affich√©es
**Sympt√¥me**: L'import de courriers affichait "0 courriers import√©s" et "2 erreurs rencontr√©es" mais sans d√©tails sur les erreurs.

**Causes identifi√©es**:
1. **Erreurs masqu√©es √† l'utilisateur**: Les d√©tails des erreurs √©taient dans `result['details']` mais n'√©taient pas affich√©s
2. **Champ utilisateur_id manquant**: Si aucun utilisateur valide n'√©tait trouv√©, le champ `utilisateur_id` (NOT NULL) restait vide, causant une erreur de contrainte SQL
3. **Manque de logging**: Pas assez de logs pour diagnostiquer les probl√®mes d'import

**Corrections apport√©es**:

1. **Affichage des d√©tails d'erreur** (views.py):
   ```python
   if result['errors'] > 0:
       flash(f'{result["errors"]} erreurs rencontr√©es', 'warning')
       # Afficher les d√©tails des erreurs
       for detail in result.get('details', []):
           if 'Erreur' in detail or 'erreur' in detail:
               flash(f'  ‚Ä¢ {detail}', 'error')
   ```
   - Les messages d'erreur d√©taill√©s sont maintenant affich√©s √† l'utilisateur

2. **Validation robuste de utilisateur_id** (export_import_utils.py):
   - Ajout de `is_deleted=False` au filtre de recherche super admin
   - **Fallback intelligent**: Si aucun super admin actif n'existe, utilise le premier utilisateur actif trouv√©
   - **Message d'erreur clair**: Si aucun utilisateur actif n'existe, erreur explicite au lieu d'√©chec silencieux
   
   ```python
   # Priorit√© 4: super admin par d√©faut
   default_user = User.query.filter_by(role='super_admin', is_deleted=False).first()
   if default_user:
       new_courrier.utilisateur_id = default_user.id
   else:
       # Fallback: premier utilisateur actif trouv√©
       fallback_user = User.query.filter_by(is_deleted=False).first()
       if fallback_user:
           new_courrier.utilisateur_id = fallback_user.id
       else:
           raise ValueError("Aucun utilisateur actif trouv√©")
   ```

3. **Logging am√©lior√©**:
   - Ajout de logs au d√©but de l'import de chaque courrier
   - Logs lors du skip de courriers existants
   - Meilleure tra√ßabilit√© des op√©rations d'import

**R√©sultat**:
- ‚úÖ Les erreurs d'import sont maintenant visibles et compr√©hensibles
- ‚úÖ Validation robuste du champ utilisateur_id obligatoire
- ‚úÖ Messages d'erreur clairs pour faciliter le d√©bogage
- ‚úÖ Import fonctionnel m√™me sans super admin dans le syst√®me

**Action pour l'utilisateur**:
1. R√©essayer l'import - les erreurs seront maintenant affich√©es clairement
2. V√©rifier qu'au moins un utilisateur actif existe dans le syst√®me
3. Si des courriers sont d√©j√† pr√©sents, ils seront ignor√©s (mode skip_existing par d√©faut)

---

## [Correction Page de Connexion et Pages d'Erreur] - 2025-10-15

### üêõ Corrections Critiques

#### Page de connexion blanche (erreur 429)
**Probl√®me**: La page de connexion affichait parfois une page blanche avec seulement le pied de page visible.

**Causes identifi√©es**:
1. **Limitation de d√©bit trop stricte**: 10 requ√™tes/15min bloquait les utilisateurs l√©gitimes
2. **Page d'erreur 429 cass√©e**: Template `429.html` plantait avec `'parametres' is undefined`
3. **Cascade d'erreurs**: L'erreur de la page d'erreur cr√©ait une page blanche

**Corrections apport√©es**:

1. **Augmentation de la limite de d√©bit** (views.py):
   - Ancien: `@rate_limit(max_requests=10, per_minutes=15)`
   - Nouveau: `@rate_limit(max_requests=30, per_minutes=15)`
   - Permet maintenant les tentatives l√©gitimes (fautes de frappe, oubli de mot de passe)

2. **Correction des gestionnaires d'erreur** (app.py):
   - Gestionnaire 429: Ajout de `parametres` au contexte du template
   - Gestionnaire 403: Ajout de `parametres` au contexte du template
   - Gestion des exceptions si `parametres` n'est pas disponible

3. **Renforcement des templates d'erreur**:
   - `429.html`: `{{ parametres.nom_logiciel if parametres else 'GEC' }}`
   - `403.html`: `{{ parametres.nom_logiciel if parametres else 'GEC' }}`
   - Gestion gracieuse de l'absence de `parametres`

**R√©sultat**:
- ‚úÖ Page de connexion fonctionne normalement
- ‚úÖ Plus de pages blanches lors de blocage par rate limit
- ‚úÖ Pages d'erreur s'affichent correctement
- ‚úÖ S√©curit√© maintenue (rate limiting et blocage IP actifs)

---

## [Correction Export/Import de Courriers] - 2025-10-15

### üêõ Correction Critique

#### Erreur d'import PieceJointe
**Probl√®me**: L'export/import de courriers √©chouait avec l'erreur `cannot import name 'PieceJointe' from 'models'`

**Cause**: Le fichier `export_import_utils.py` tentait d'importer une classe `PieceJointe` qui n'existe pas dans le mod√®le de donn√©es. Le syst√®me GEC stocke une seule pi√®ce jointe par courrier directement dans le mod√®le `Courrier` via les champs:
- `fichier_nom`: Nom du fichier
- `fichier_chemin`: Chemin de stockage
- `fichier_type`: Type MIME
- `fichier_checksum`: Somme de contr√¥le SHA-256
- `fichier_encrypted`: Indicateur de chiffrement

**Corrections apport√©es** (export_import_utils.py):
1. Suppression de l'import inexistant: `from models import Courrier, CourrierForward, PieceJointe` ‚Üí `from models import Courrier, CourrierForward`
2. Suppression du code g√©rant les "pi√®ces jointes suppl√©mentaires" (lignes 117-129) qui n'existent pas dans ce syst√®me

**üìã Guide de Correction pour Anciennes Installations**

Si vous rencontrez cette erreur sur une autre installation GEC, voici comment la corriger:

1. **Ouvrir le fichier `export_import_utils.py`**
   
2. **Localiser la ligne d'import** (g√©n√©ralement ligne 14):
   ```python
   # ‚ùå ANCIEN CODE (√Ä CORRIGER):
   from models import Courrier, CourrierForward, PieceJointe
   
   # ‚úÖ NOUVEAU CODE (CORRECT):
   from models import Courrier, CourrierForward
   ```

3. **Supprimer toute r√©f√©rence √† PieceJointe** dans le fichier:
   - Rechercher `PieceJointe` dans tout le fichier
   - Supprimer ou commenter les lignes qui utilisent cette classe
   - Le syst√®me GEC n'a JAMAIS eu de mod√®le `PieceJointe` s√©par√©

4. **Red√©marrer l'application** apr√®s la correction

**V√©rification rapide:**
```bash
# V√©rifier qu'il n'y a plus d'import PieceJointe
grep -n "PieceJointe" export_import_utils.py
# Cette commande ne devrait rien retourner
```

**Note importante:** Cette correction est d√©j√† appliqu√©e sur l'installation Replit. Cette section du CHANGELOG est destin√©e aux utilisateurs qui migrent depuis d'anciennes versions du code.

### ‚úÖ Fonctionnalit√© Export/Import Valid√©e

#### Processus d'Export (D√©chiffrement)
L'export effectue les op√©rations suivantes:
1. **D√©chiffrement des donn√©es sensibles**:
   - Objet du courrier
   - Exp√©diteur
   - Destinataire  
   - Num√©ro de r√©f√©rence

2. **D√©chiffrement des fichiers**:
   - Les fichiers chiffr√©s sont d√©chiffr√©s temporairement
   - Ajout√©s au package ZIP en clair
   - Fichiers temporaires nettoy√©s automatiquement
   - En cas d'erreur de d√©chiffrement, l'export √©choue (√©vite le double chiffrement)

3. **Structure du package d'export** (.zip):
   ```
   export_courriers_[timestamp].zip
   ‚îú‚îÄ‚îÄ courriers_data.json       # M√©tadonn√©es et donn√©es d√©chiffr√©es
   ‚îî‚îÄ‚îÄ attachments/              # Fichiers en clair (d√©chiffr√©s)
       ‚îî‚îÄ‚îÄ [courrier_id]_[filename]
   ```

#### Processus d'Import (Re-chiffrement)
L'import effectue les op√©rations suivantes:
1. **Re-chiffrement des donn√©es sensibles**:
   - Chiffrement avec la cl√© ma√Ætre de la nouvelle instance
   - Stockage dans les champs `*_encrypted`

2. **Re-chiffrement des fichiers**:
   - Les fichiers en clair sont re-chiffr√©s avec la cl√© de la nouvelle instance
   - Sauvegarde dans le dossier `uploads/`
   - Extension `.encrypted` ajout√©e aux fichiers chiffr√©s

3. **Gestion des utilisateurs**:
   - Priorit√© 1: `assign_to_user_id` (si fourni)
   - Priorit√© 2: Utilisateur d'origine (si existe)
   - Priorit√© 3: Mapping fourni
   - Priorit√© 4: Super admin par d√©faut

4. **Gestion des doublons**:
   - V√©rification par `numero_accuse_reception`
   - Option `skip_existing` pour ignorer les doublons

### üîí S√©curit√©
- ‚úÖ Donn√©es sensibles d√©chiffr√©es uniquement pendant l'export
- ‚úÖ Re-chiffrement automatique avec nouvelle cl√© √† l'import
- ‚úÖ Fichiers temporaires nettoy√©s apr√®s traitement
- ‚úÖ Support de cl√©s de chiffrement diff√©rentes entre instances

### üåç Traductions
**Langues supprim√©es**: Espagnol (es.json) et Allemand (de.json)
**Langues conserv√©es**: Fran√ßais (fr.json) et Anglais (en.json)

Traductions ajout√©es pour les deux langues:
- Toutes les cl√©s de la page `/manage_backups`
- Fonctionnalit√©s d'export/import de courriers
- Messages de s√©curit√© et validation

---

## [Corrections Page Sauvegardes et Traductions] - 2025-10-15

### üêõ Corrections de Bugs

#### Page /manage_backups
**Probl√®me**: La page `/manage_backups` plantait avec une erreur 500 et les sections d'export/import de courriers n'√©taient pas visibles.

**Corrections apport√©es**:
1. **Correction attribut base de donn√©es** (views.py ligne 5482)
   - Ancienne requ√™te: `User.query.filter_by(is_deleted=False)` 
   - Nouvelle requ√™te: `User.query.filter_by(actif=True)`
   - Raison: Le mod√®le User utilise l'attribut `actif` et non `is_deleted`
   
2. **Visibilit√© des sections Export/Import**
   - Suppression de la condition Jinja redondante `{% if current_user.is_super_admin() %}`
   - D√©placement des sections en haut de page (juste apr√®s les statistiques)
   - Ajout d'une bordure violette distinctive pour une meilleure visibilit√©
   - Les v√©rifications de permissions restent actives dans les routes POST

#### Traductions fran√ßaises
**Probl√®me**: Plusieurs termes n'√©taient pas traduits et s'affichaient en anglais.

**Traductions ajout√©es** (lang/fr.json):
- `backup_management`: "Gestion des Sauvegardes"
- `create_security_backup`: "Sauvegarde de S√©curit√© (Avant MAJ)"
- `security_backup_feature`: "Sauvegarde de s√©curit√© : Protection des param√®tres critiques"
- `export_courriers`: "Export de Courriers"
- `import_courriers`: "Import de Courriers"
- `export_courriers_description`, `import_courriers_description`
- `export_features`, `import_features`
- `export_decrypts_data`, `import_encrypts_data`
- `export_includes_attachments`, `import_restores_attachments`
- `export_portable`, `import_handles_duplicates`
- `export_security`, `import_statistics`
- Et 30+ autres traductions pour la page de gestion des sauvegardes

### üé® Am√©liorations UI/UX

#### Organisation de la page
- **Nouvelle structure visuelle**:
  1. Cartes statistiques (en haut)
  2. **Export/Import de Courriers** (bordure violette - imm√©diatement visible)
  3. Cr√©ation et Restauration de sauvegardes
  4. Liste des sauvegardes disponibles
  5. Mise √† jour syst√®me

- Sections export/import maintenant **hautement visibles** sans scroll
- Design coh√©rent avec bordures et ic√¥nes color√©es

### ‚úÖ Tests Effectu√©s
- Page `/manage_backups` charge sans erreur (HTTP 200)
- Formulaires d'export et d'import pr√©sents et fonctionnels
- Toutes les traductions affich√©es correctement en fran√ßais
- V√©rifications de s√©curit√© maintenues (super_admin uniquement)

---

## [Migration Replit Agent] - 2025-10-15

### ‚úÖ Migration Compl√©t√©e

#### Infrastructure
- ‚úÖ Installation de l'environnement Python 3.11
- ‚úÖ Installation de toutes les d√©pendances du projet via pyproject.toml
  - Flask 3.1.1 et extensions (flask-login, flask-sqlalchemy)
  - PostgreSQL (psycopg2-binary)
  - Cryptographie (cryptography, pycryptodome, bcrypt)
  - G√©n√©ration de documents (reportlab, xlsxwriter, pandas)
  - Traitement d'images (opencv-python, pillow)
  - Communication (sendgrid, requests)
  - Serveur web (gunicorn)

#### D√©ploiement
- ‚úÖ Configuration du workflow "Start application" avec gunicorn
  - Commande: `gunicorn --bind 0.0.0.0:5000 --reuse-port --reload main:app`
  - Port: 5000 (seul port non-firewal√©)
  - Auto-reload activ√© pour le d√©veloppement
- ‚úÖ Configuration du d√©ploiement en production (autoscale)
  - Type: autoscale (adapt√© aux sites web stateless)
  - Build: Non requis (Python interpr√©t√©)
  - Run: `gunicorn --bind 0.0.0.0:5000 main:app`

#### Application
- ‚úÖ V√©rification du bon fonctionnement de l'application
  - Interface de connexion op√©rationnelle
  - Base de donn√©es PostgreSQL initialis√©e
  - Utilisateur admin par d√©faut cr√©√© (username: sa.gec001)
  - Tables et sch√©ma de base de donn√©es cr√©√©s
  - Migrations automatiques appliqu√©es

### üÜï Nouvelles Fonctionnalit√©s

#### Module d'Export/Import de Courriers (export_import_utils.py)
**Probl√®me r√©solu**: Les sauvegardes/restaurations √©chouaient lors du transfert entre instances GEC diff√©rentes car les donn√©es chiffr√©es avec la cl√© `GEC_MASTER_KEY` d'une instance ne pouvaient pas √™tre d√©chiffr√©es avec la cl√© d'une autre instance.

**Solution impl√©ment√©e**:

1. **Fonction `export_courriers_to_json()`**
   - Exporte les courriers en format JSON
   - **D√©chiffre automatiquement** toutes les donn√©es sensibles avant export:
     - Objet du courrier (objet_encrypted ‚Üí objet en clair)
     - Exp√©diteur (expediteur_encrypted ‚Üí expediteur en clair)
     - Destinataire (destinataire_encrypted ‚Üí destinataire en clair)
     - Num√©ro de r√©f√©rence (numero_reference_encrypted ‚Üí numero_reference en clair)
   - G√®re les pi√®ces jointes avec leur statut de chiffrement
   - Inclut les m√©tadonn√©es de version pour compatibilit√©

2. **Fonction `create_export_package()`**
   - Cr√©e un package ZIP complet avec:
     - Fichier JSON contenant les donn√©es d√©chiffr√©es
     - Fichiers attach√©s **d√©chiffr√©s** (extraits du chiffrement avec la cl√© source)
     - Pi√®ces jointes des transmissions
     - M√©tadonn√©es d'export (version, date, nombre de courriers)
   - Format: `export_courriers_YYYYMMDD_HHMMSS.zip`
   - Stockage dans le dossier `exports/`

3. **Fonction `import_courriers_from_package()`**
   - Importe les courriers depuis un package ZIP
   - **Re-chiffre automatiquement** avec la cl√© de l'instance de destination:
     - Objet en clair ‚Üí objet_encrypted avec nouvelle cl√©
     - Exp√©diteur en clair ‚Üí expediteur_encrypted avec nouvelle cl√©
     - Destinataire en clair ‚Üí destinataire_encrypted avec nouvelle cl√©
     - Num√©ro de r√©f√©rence en clair ‚Üí numero_reference_encrypted avec nouvelle cl√©
   - Re-chiffre les fichiers attach√©s avec la nouvelle cl√©
   - Options:
     - `skip_existing`: Ignore les courriers d√©j√† pr√©sents (par num√©ro)
     - `remap_users`: Remapper les utilisateurs entre instances
   - Gestion des erreurs et statistiques d'import d√©taill√©es

**Format d'Export (v1.0.0)**:
```json
{
  "version": "1.0.0",
  "export_date": "2025-10-15T...",
  "total_courriers": 100,
  "courriers": [
    {
      "id": 1,
      "numero_accuse_reception": "GEC-2025-001",
      "objet": "Objet d√©chiffr√© en clair",
      "expediteur": "Exp√©diteur d√©chiffr√© en clair",
      "destinataire": "Destinataire d√©chiffr√© en clair",
      "numero_reference": "R√©f√©rence d√©chiffr√©e en clair",
      "forwards": [...],
      ...
    }
  ],
  "attachments": [
    {
      "courrier_id": 1,
      "type": "main",
      "filename": "document.pdf",
      "path": "uploads/...",
      "encrypted": true,
      "checksum": "sha256..."
    }
  ]
}
```

#### Routes Flask Ajout√©es (views.py)

1. **Route `/export_courriers` (POST)**
   - R√©serv√©e aux super administrateurs
   - Param√®tres:
     - `export_all`: Exporter tous les courriers (incluant supprim√©s)
     - `courrier_ids`: Liste d'IDs sp√©cifiques √† exporter
   - T√©l√©charge automatiquement le fichier ZIP d'export
   - Log de l'activit√© dans le journal d'audit

2. **Route `/import_courriers` (POST)**
   - R√©serv√©e aux super administrateurs
   - Upload d'un fichier ZIP d'export
   - Param√®tres:
     - `skip_existing`: Ignorer les doublons (par d√©faut: true)
   - Affiche les statistiques d√©taill√©es:
     - Nombre de courriers import√©s
     - Nombre de courriers ignor√©s (doublons)
     - Nombre d'erreurs rencontr√©es
   - Log de l'activit√© avec d√©tails

#### Interface Utilisateur (templates/manage_backups.html)

**‚úÖ Int√©gration UI Compl√©t√©e - 2025-10-15**

1. **Section Export de Courriers**
   - Formulaire d'export accessible aux super administrateurs uniquement
   - Options disponibles:
     - ‚òëÔ∏è Exporter tous les courriers (incluant supprim√©s)
     - üìù S√©lection d'IDs sp√©cifiques (format: 1,2,3,10)
   - Bouton "Exporter les Courriers" ‚Üí POST vers `/export_courriers`
   - Informations affich√©es:
     - D√©chiffrement automatique des donn√©es
     - Inclusion des pi√®ces jointes
     - Format portable entre instances
     - Package ZIP s√©curis√©

2. **Section Import de Courriers**
   - Formulaire d'import accessible aux super administrateurs uniquement
   - Upload de fichier ZIP d'export
   - Options disponibles:
     - ‚òëÔ∏è Ignorer les doublons (recommand√©, coch√© par d√©faut)
   - Bouton "Importer les Courriers" ‚Üí POST vers `/import_courriers`
   - Informations affich√©es:
     - Re-chiffrement automatique avec cl√© locale
     - Gestion des doublons
     - Restauration des pi√®ces jointes
     - Statistiques d√©taill√©es apr√®s import

3. **Placement dans l'interface**
   - Nouvellement ajout√© dans la page "Gestion des Sauvegardes"
   - Section situ√©e entre les backups syst√®me et la table des sauvegardes disponibles
   - Visible uniquement pour les super administrateurs
   - Design coh√©rent avec le reste de l'application (Tailwind CSS)

#### S√©curit√© et Chiffrement

**Gestion des Cl√©s de Chiffrement**:
- Chaque instance GEC poss√®de sa propre cl√© `GEC_MASTER_KEY` (256-bit AES)
- Les donn√©es sensibles sont chiffr√©es avec AES-256-CBC
- Le processus export/import assure la compatibilit√© entre instances:
  1. **Export**: D√©chiffrement avec cl√© source ‚Üí stockage en clair (s√©curis√© dans ZIP)
  2. **Import**: Re-chiffrement avec cl√© destination ‚Üí stockage s√©curis√©

**Avantages**:
- ‚úÖ Transfert s√©curis√© de courriers entre instances GEC
- ‚úÖ Pas de perte de donn√©es lors des migrations
- ‚úÖ Compatibilit√© garantie entre versions identiques
- ‚úÖ Tra√ßabilit√© compl√®te via logs d'audit

### üîß Am√©liorations Syst√®me

#### Gestion des Sauvegardes
- Le syst√®me de backup existant (`create_system_backup`, `restore_system_from_backup`) reste inchang√©
- Nouveau syst√®me export/import d√©di√© au transfert de courriers entre instances
- S√©paration claire:
  - **Backups syst√®me**: Sauvegarde compl√®te de l'instance (avec cl√©s chiffr√©es)
  - **Export/Import**: Transfert de courriers entre instances (avec re-chiffrement)

#### Logs et Tra√ßabilit√©
- Nouveaux types d'activit√©s dans le journal:
  - `EXPORT_COURRIERS`: Export de courriers effectu√©
  - `IMPORT_COURRIERS`: Import de courriers avec statistiques

### ‚ö†Ô∏è Points d'Attention

#### Variables d'Environnement Critiques
Les cl√©s suivantes doivent √™tre configur√©es pour la persistence et la s√©curit√©:

1. **GEC_MASTER_KEY** (CRITIQUE)
   - Cl√© de chiffrement principale (256-bit)
   - G√©n√©r√©e automatiquement si absente (voir logs CRITICAL)
   - ‚ö†Ô∏è DOIT √™tre sauvegard√©e et configur√©e en production
   - Utilis√©e pour chiffrer toutes les donn√©es sensibles

2. **GEC_PASSWORD_SALT** (CRITIQUE)
   - Sel pour le hachage des mots de passe
   - G√©n√©r√© automatiquement si absent (voir logs CRITICAL)
   - ‚ö†Ô∏è DOIT √™tre sauvegard√© et configur√© en production

3. **SESSION_SECRET**
   - Secret pour les sessions Flask
   - Configur√© par d√©faut: "dev-secret-key-gec-mines"
   - ‚ö†Ô∏è Doit √™tre chang√© en production

4. **DATABASE_URL**
   - URL de connexion PostgreSQL
   - Par d√©faut: SQLite (gec_mines.db)
   - ‚ö†Ô∏è Utiliser PostgreSQL en production

5. **ADMIN_PASSWORD**
   - Mot de passe de l'utilisateur admin initial (sa.gec001)
   - Par d√©faut: "TempPassword123!"
   - ‚ö†Ô∏è Doit √™tre chang√© imm√©diatement apr√®s premi√®re connexion

#### Configuration Sendgrid
- Int√©gration Sendgrid configur√©e mais n√©cessite setup
- Voir `use_integration` pour configurer les cl√©s API

### üìã √Ä Faire (TODO)

#### Configuration Initiale Requise
1. ‚ö†Ô∏è **URGENT**: Configurer les cl√©s de chiffrement en production
   ```bash
   # G√©n√©rer les cl√©s (utiliser generate_keys.py si disponible)
   # Puis configurer dans Secrets Replit:
   GEC_MASTER_KEY=<cl√©_base64>
   GEC_PASSWORD_SALT=<sel_base64>
   SESSION_SECRET=<secret_aleatoire>
   ```

2. ‚ö†Ô∏è Changer le mot de passe admin par d√©faut
   - Utilisateur: sa.gec001
   - Mot de passe par d√©faut: TempPassword123!

3. Configurer Sendgrid pour les notifications email
   - Utiliser l'int√©gration Replit Sendgrid
   - Configurer les templates d'email

#### Optimisations Futures
- [ ] Ajouter compression des exports pour fichiers volumineux
- [ ] Impl√©menter import/export incr√©mental (par date)
- [ ] Ajouter validation de sch√©ma avant import
- [ ] Interface utilisateur pour s√©lection de courriers √† exporter
- [ ] Support multi-version pour compatibilit√© ascendante/descendante
- [ ] Export/import des utilisateurs et d√©partements associ√©s
- [ ] Chiffrement du fichier ZIP d'export pour transit s√©curis√©

### üêõ Corrections de Bugs

#### Probl√®me de Restauration entre Instances
- **Probl√®me**: Les sauvegardes restaur√©es sur une autre instance ne fonctionnaient pas car les donn√©es chiffr√©es ne pouvaient pas √™tre d√©chiffr√©es
- **Cause**: Cl√©s de chiffrement `GEC_MASTER_KEY` diff√©rentes entre instances
- **Solution**: Nouveau syst√®me export/import avec d√©chiffrement/rechiffrement automatique

#### Bug Critique Corrig√©: Double Chiffrement des Fichiers (v1.0.1)
- **Probl√®me Identifi√©**: Lors de l'export, si un fichier ne pouvait pas √™tre d√©chiffr√©, il √©tait ajout√© tel quel (chiffr√©) au package ZIP
- **Cons√©quence**: √Ä l'import, ces fichiers d√©j√† chiffr√©s √©taient re-chiffr√©s avec la nouvelle cl√©, cr√©ant un double chiffrement et rendant les fichiers inutilisables
- **Solution Impl√©ment√©e**:
  1. L'export √©choue maintenant compl√®tement si un fichier ne peut pas √™tre d√©chiffr√©
  2. Le fichier ZIP incomplet est automatiquement supprim√©
  3. Un message d'erreur d√©taill√© liste tous les fichiers probl√©matiques
  4. Aucun fichier chiffr√© ne peut √™tre ajout√© √† l'export par erreur
- **Validation**: L'import v√©rifie maintenant la pr√©sence des fichiers et √©met des avertissements clairs si des fichiers sont manquants

### üìä Statistiques du Projet

#### Fichiers Modifi√©s
- ‚úÖ `export_import_utils.py` - CR√â√â (nouveau module)
- ‚úÖ `views.py` - MODIFI√â (2 nouvelles routes)
- ‚úÖ `CHANGELOG.md` - CR√â√â (ce fichier)
- ‚úÖ `.local/state/replit/agent/progress_tracker.md` - MIS √Ä JOUR

#### Fonctionnalit√©s Ajout√©es
- Export de courriers avec d√©chiffrement
- Import de courriers avec rechiffrement
- Package ZIP portable entre instances
- Gestion des pi√®ces jointes chiffr√©es
- Logs et tra√ßabilit√© d'export/import

### üìñ Documentation

#### Guide d'Utilisation - Export

1. Se connecter en tant que super administrateur
2. Aller dans "Gestion des sauvegardes"
3. Section "Export de Courriers"
4. Options:
   - Exporter tous les courriers
   - OU sp√©cifier des IDs de courriers (s√©par√©s par virgules)
5. Cliquer sur "Exporter"
6. Le fichier ZIP sera t√©l√©charg√© automatiquement

#### Guide d'Utilisation - Import

1. Se connecter en tant que super administrateur sur l'instance cible
2. Aller dans "Gestion des sauvegardes"
3. Section "Import de Courriers"
4. S√©lectionner le fichier ZIP d'export
5. Options:
   - Ignorer les doublons (recommand√©)
6. Cliquer sur "Importer"
7. Consulter les statistiques d'import affich√©es

#### S√©curit√© du Processus

**Export**:
1. Les donn√©es sont extraites de la base de donn√©es
2. Les champs chiffr√©s sont d√©chiffr√©s avec `GEC_MASTER_KEY` source
3. Les fichiers attach√©s chiffr√©s sont d√©chiffr√©s
4. Tout est empaquet√© dans un ZIP (donn√©es en clair, s√©curis√©)
5. ‚ö†Ô∏è Le fichier ZIP doit √™tre transf√©r√© de mani√®re s√©curis√©e (HTTPS, SSH, etc.)

**Import**:
1. Le ZIP est extrait dans un dossier temporaire
2. Les donn√©es JSON sont lues
3. Pour chaque courrier:
   - Les donn√©es en clair sont lues
   - Les donn√©es sont re-chiffr√©es avec `GEC_MASTER_KEY` destination
   - Les fichiers sont re-chiffr√©s avec la nouvelle cl√©
   - Les donn√©es sont ins√©r√©es dans la base
4. Le dossier temporaire est nettoy√©

### ‚úÖ Tests Effectu√©s

- ‚úÖ Application d√©marre correctement avec gunicorn
- ‚úÖ Base de donn√©es PostgreSQL initialis√©e
- ‚úÖ Interface web accessible sur port 5000
- ‚úÖ Page de connexion fonctionnelle
- ‚úÖ Utilisateur admin cr√©√© automatiquement
- ‚úÖ Migrations automatiques appliqu√©es
- ‚úÖ Syst√®me de chiffrement op√©rationnel (avec warnings de configuration)

### üîç Tests √† Effectuer

- [ ] Test d'export de courriers r√©els
- [ ] Test d'import sur instance avec cl√© diff√©rente
- [ ] V√©rification de l'int√©grit√© des donn√©es apr√®s import
- [ ] Test des pi√®ces jointes chiffr√©es
- [ ] Test des courriers avec transmissions
- [ ] Test de performance avec grand volume de donn√©es
- [ ] Test de gestion des erreurs et rollback

---

## Notes Techniques

### Architecture du Syst√®me d'Export/Import

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Instance A     ‚îÇ         ‚îÇ  Package ZIP     ‚îÇ         ‚îÇ  Instance B     ‚îÇ
‚îÇ  (GEC_KEY_A)    ‚îÇ         ‚îÇ  (donn√©es claires)‚îÇ         ‚îÇ  (GEC_KEY_B)    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                 ‚îÇ         ‚îÇ                  ‚îÇ         ‚îÇ                 ‚îÇ
‚îÇ Donn√©es crypt√©es‚îÇ‚îÄExport‚îÄ‚Üí‚îÇ Donn√©es en clair ‚îÇ‚îÄImport‚îÄ‚Üí‚îÇ Donn√©es crypt√©es‚îÇ
‚îÇ avec KEY_A      ‚îÇ         ‚îÇ + fichiers       ‚îÇ         ‚îÇ avec KEY_B      ‚îÇ
‚îÇ                 ‚îÇ         ‚îÇ                  ‚îÇ         ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                            ‚îÇ                            ‚îÇ
       ‚ñº                            ‚ñº                            ‚ñº
  D√©chiffrement              Format portable               Re-chiffrement
   avec KEY_A                  (JSON + ZIP)                 avec KEY_B
```

### Format de Versioning

- Format d'export: v1.0.0
- Compatibilit√©: M√™me version majeure (1.x.x)
- Migration automatique du sch√©ma via migration_utils.py

### D√©pendances Critiques

- **encryption_utils.py**: Gestion du chiffrement/d√©chiffrement
- **models.py**: Mod√®les Courrier, PieceJointe, CourrierForward
- **utils.py**: Fonctions utilitaires et backup syst√®me
- **migration_utils.py**: Migrations automatiques de sch√©ma

---

*Derni√®re mise √† jour: 2025-10-15*
*Cr√©√© pendant la migration Replit Agent*
